<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Call Integration Example - Nihongo Sekai</title>
    <style>
      /* Video Call Container Styling */
      .video-call-section {
        background: #1a1a1a;
        border-radius: 12px;
        overflow: hidden;
        margin: 2rem 0;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }

      .video-call-header {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .video-call-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
      }

      .video-call-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.875rem;
        opacity: 0.9;
      }

      .participant-count-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        background: #22c55e;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .video-call-container {
        width: 100%;
        height: 400px;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.125rem;
      }

      .video-call-controls {
        background: #2d2d2d;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .control-group {
        display: flex;
        gap: 0.75rem;
      }

      .control-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border: 1px solid #555;
        background: #333;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s ease;
      }

      .control-btn:hover {
        background: #444;
        border-color: #666;
      }

      .control-btn.active {
        background: #dc2626;
        border-color: #dc2626;
      }

      .control-btn.danger {
        background: #dc2626;
        border-color: #dc2626;
      }

      .control-btn.danger:hover {
        background: #b91c1c;
      }

      .recording-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #ef4444;
        font-weight: 500;
      }

      .recording-dot {
        width: 8px;
        height: 8px;
        background: #ef4444;
        border-radius: 50%;
        animation: pulse 1s infinite;
      }

      /* Loading State */
      .video-call-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        color: #9ca3af;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #374151;
        border-top: 3px solid #dc2626;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Error State */
      .video-call-error {
        padding: 2rem;
        text-align: center;
        color: #ef4444;
      }

      .error-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      .error-message {
        font-size: 1.125rem;
        margin-bottom: 1rem;
      }

      .retry-btn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s ease;
      }

      .retry-btn:hover {
        background: #b91c1c;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .video-call-header {
          flex-direction: column;
          gap: 0.75rem;
          align-items: flex-start;
        }

        .video-call-controls {
          flex-direction: column;
          align-items: stretch;
        }

        .control-group {
          justify-content: center;
        }

        .video-call-container {
          height: 250px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Example Video Call Integration -->
    <div class="video-call-section">
      <!-- Header with info -->
      <div class="video-call-header">
        <h3 class="video-call-title">Japanese Conversation Practice</h3>
        <div class="video-call-info">
          <div class="participant-count-badge">
            <div class="status-indicator"></div>
            <span class="participant-count">0</span> participants
          </div>
          <span id="call-duration">00:00</span>
        </div>
      </div>

      <!-- Video Container -->
      <div id="video-call-container" class="video-call-container">
        <div class="video-call-loading">
          <div class="spinner"></div>
          <p>Preparing video call...</p>
        </div>
      </div>

      <!-- Controls -->
      <div class="video-call-controls">
        <div class="control-group">
          <button id="camera-btn" class="control-btn active">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polygon points="23 7 16 12 23 17 23 7"></polygon>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
            </svg>
            Camera
          </button>

          <button id="mic-btn" class="control-btn active">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
              ></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
              <line x1="12" y1="19" x2="12" y2="23"></line>
              <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
            Microphone
          </button>

          <button id="screen-share-btn" class="control-btn">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
              <line x1="8" y1="21" x2="16" y2="21"></line>
              <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
            Share Screen
          </button>
        </div>

        <div class="control-group">
          <div
            id="recording-status"
            class="recording-indicator"
            style="display: none"
          >
            <div class="recording-dot"></div>
            <span>Recording</span>
          </div>

          <button id="record-btn" class="control-btn" style="display: none">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
            Record
          </button>

          <button id="leave-btn" class="control-btn danger">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16,17 21,12 16,7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Leave Call
          </button>
        </div>
      </div>
    </div>

    <!-- Include Daily.co SDK -->
    <script src="https://unpkg.com/@daily-co/daily-js"></script>

    <!-- Include VideoCall Component -->
    <script src="VideoCall.js"></script>

    <script>
      // Example usage
      let videoCall = null;
      let callDuration = 0;
      let durationInterval = null;

      // Initialize video call when page loads
      document.addEventListener("DOMContentLoaded", async () => {
        await initializeVideoCall();
        setupControlHandlers();
      });

      async function initializeVideoCall() {
        try {
          // Mock classroom and user data
          const classroomId = "1";
          const userId = "123";
          const isHost = true; // Determine based on user role

          // Show recording button for hosts
          if (isHost) {
            document.getElementById("record-btn").style.display = "flex";
          }

          // Create video call instance
          videoCall = new VideoCallComponent("video-call-container", {
            userName: "John Doe",
            userId: userId,
            isHost: isHost,
            onParticipantJoined: handleParticipantJoined,
            onParticipantLeft: handleParticipantLeft,
            onCallEnded: handleCallEnded,
            onError: handleError,
          });

          // Set up event listeners
          setupVideoCallEvents();

          // For demo purposes, simulate initialization
          // In real app, this would call videoCall.init() with real credentials
          simulateVideoCallInit();
        } catch (error) {
          showError("Failed to initialize video call", error.message);
        }
      }

      function simulateVideoCallInit() {
        // Simulate loading delay
        setTimeout(() => {
          const container = document.getElementById("video-call-container");
          container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af;">
                        <div style="text-align: center;">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem;">
                                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                            </svg>
                            <p>Video call ready</p>
                            <p style="font-size: 0.875rem; opacity: 0.7;">Camera and microphone permissions required</p>
                        </div>
                    </div>
                `;

          // Start duration timer
          startDurationTimer();

          // Simulate participant count update
          updateParticipantCount(1);
        }, 2000);
      }

      function setupVideoCallEvents() {
        // Listen for video call events
        document.addEventListener("videoCall:participantJoined", (e) => {
          console.log("Participant joined:", e.detail);
        });

        document.addEventListener("videoCall:participantLeft", (e) => {
          console.log("Participant left:", e.detail);
        });

        document.addEventListener("videoCall:participantCountChanged", (e) => {
          updateParticipantCount(e.detail.count);
        });

        document.addEventListener("videoCall:recordingStarted", (e) => {
          showRecordingStatus(true);
        });

        document.addEventListener("videoCall:recordingStopped", (e) => {
          showRecordingStatus(false);
        });
      }

      function setupControlHandlers() {
        let cameraEnabled = true;
        let micEnabled = true;
        let isRecording = false;

        // Camera toggle
        document.getElementById("camera-btn").addEventListener("click", () => {
          cameraEnabled = !cameraEnabled;
          const btn = document.getElementById("camera-btn");
          btn.classList.toggle("active", cameraEnabled);
          btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        ${
                          cameraEnabled
                            ? '<polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>'
                            : '<line x1="1" y1="1" x2="23" y2="23"></line><path d="M21 21H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3m3-3h6l2 3h4a2 2 0 0 1 2 2v9.34m-7.72-2.06L15 15"></path>'
                        }
                    </svg>
                    Camera
                `;

          if (videoCall) {
            videoCall.setCamera(cameraEnabled);
          }
        });

        // Microphone toggle
        document.getElementById("mic-btn").addEventListener("click", () => {
          micEnabled = !micEnabled;
          const btn = document.getElementById("mic-btn");
          btn.classList.toggle("active", micEnabled);
          btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        ${
                          micEnabled
                            ? '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>'
                            : '<line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>'
                        }
                    </svg>
                    Microphone
                `;

          if (videoCall) {
            videoCall.setMicrophone(micEnabled);
          }
        });

        // Screen share toggle
        document
          .getElementById("screen-share-btn")
          .addEventListener("click", () => {
            alert("Screen sharing functionality would be implemented here");
          });

        // Recording toggle (host only)
        document
          .getElementById("record-btn")
          .addEventListener("click", async () => {
            if (!videoCall) return;

            try {
              if (!isRecording) {
                await videoCall.startRecording();
                isRecording = true;
              } else {
                await videoCall.stopRecording();
                isRecording = false;
              }
            } catch (error) {
              alert("Recording error: " + error.message);
            }
          });

        // Leave call
        document.getElementById("leave-btn").addEventListener("click", () => {
          if (confirm("Are you sure you want to leave the call?")) {
            leaveCall();
          }
        });
      }

      function updateParticipantCount(count) {
        document.querySelector(".participant-count").textContent = count;
      }

      function startDurationTimer() {
        durationInterval = setInterval(() => {
          callDuration++;
          const minutes = Math.floor(callDuration / 60);
          const seconds = callDuration % 60;
          document.getElementById("call-duration").textContent =
            `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }, 1000);
      }

      function showRecordingStatus(recording) {
        const status = document.getElementById("recording-status");
        const btn = document.getElementById("record-btn");

        if (recording) {
          status.style.display = "flex";
          btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                    Stop Recording
                `;
        } else {
          status.style.display = "none";
          btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Record
                `;
        }
      }

      function showError(title, message) {
        const container = document.getElementById("video-call-container");
        container.innerHTML = `
                <div class="video-call-error">
                    <div class="error-icon">⚠️</div>
                    <div class="error-message">${title}</div>
                    <p>${message}</p>
                    <button class="retry-btn" onclick="initializeVideoCall()">Try Again</button>
                </div>
            `;
      }

      function leaveCall() {
        if (videoCall) {
          videoCall.leave();
        }

        if (durationInterval) {
          clearInterval(durationInterval);
        }

        // Redirect or show ended state
        alert("You have left the call");
      }

      // Callback functions
      function handleParticipantJoined(participant) {
        console.log("New participant:", participant);
      }

      function handleParticipantLeft(participant) {
        console.log("Participant left:", participant);
      }

      function handleCallEnded(data) {
        console.log("Call ended:", data);
        if (durationInterval) {
          clearInterval(durationInterval);
        }
      }

      function handleError(error) {
        console.error("Video call error:", error);
        showError("Video Call Error", error.message || "An error occurred");
      }
    </script>
  </body>
</html>
