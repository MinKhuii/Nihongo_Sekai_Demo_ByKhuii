<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transactions - Nihongo Sekai</title>
    <meta
      name="description"
      content="View your purchase history and download invoices"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Global CSS -->
    <link rel="stylesheet" href="../css/global.css" />
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="../css/dashboard.css" />

    <!-- Favicon -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽŒ</text></svg>"
    />
  </head>
  <body>
    <!-- Navigation Header -->
    <header class="header">
      <nav class="navbar">
        <div class="container">
          <div class="nav-brand">
            <a href="index.html" class="brand-link">
              <span class="brand-icon">æ—¥</span>
              <span class="brand-text">
                <span class="brand-nihongo">Nihongo</span>
                <span class="brand-sekai">Sekai</span>
              </span>
            </a>
          </div>

          <div class="nav-menu" id="navMenu">
            <ul class="nav-list">
              <li><a href="index.html" class="nav-link">Home</a></li>
              <li><a href="courses.html" class="nav-link">Courses</a></li>
              <li><a href="classrooms.html" class="nav-link">Classrooms</a></li>
              <li><a href="partners.html" class="nav-link">Partners</a></li>
              <li><a href="about.html" class="nav-link">About</a></li>
            </ul>
          </div>

          <div class="nav-actions">
            <!-- Profile dropdown will be inserted here by JavaScript -->
          </div>

          <button class="nav-toggle" id="navToggle">
            <span></span>
            <span></span>
            <span></span>
          </button>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="dashboard-layout">
      <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header fade-in">
          <h1 class="dashboard-title">Transaction History</h1>
          <p class="dashboard-subtitle">
            View your purchases and download invoices
          </p>
        </div>

        <!-- Transaction Summary -->
        <div class="dashboard-grid">
          <div class="dashboard-card fade-in delay-1">
            <div class="card-header">
              <div class="card-icon">ðŸ’³</div>
              <h3 class="card-title">Total Spent</h3>
            </div>
            <div class="card-value">$384.97</div>
            <div class="card-change">lifetime purchases</div>
          </div>

          <div class="dashboard-card fade-in delay-2">
            <div class="card-header">
              <div class="card-icon">ðŸ“Š</div>
              <h3 class="card-title">This Month</h3>
            </div>
            <div class="card-value">$129.99</div>
            <div class="card-change positive">2 purchases</div>
          </div>

          <div class="dashboard-card fade-in delay-3">
            <div class="card-header">
              <div class="card-icon">ðŸ“¦</div>
              <h3 class="card-title">Total Orders</h3>
            </div>
            <div class="card-value">12</div>
            <div class="card-change">since joining</div>
          </div>

          <div class="dashboard-card fade-in delay-4">
            <div class="card-header">
              <div class="card-icon">ðŸ’Ž</div>
              <h3 class="card-title">Member Status</h3>
            </div>
            <div class="card-value">Premium</div>
            <div class="card-change positive">active subscription</div>
          </div>
        </div>

        <!-- Filter and Search -->
        <div class="search-filter-bar fade-in">
          <input
            type="text"
            id="searchTransactions"
            class="search-input"
            placeholder="Search transactions..."
          />
          <select id="filterType" class="filter-select">
            <option value="">All Types</option>
            <option value="course">Courses</option>
            <option value="classroom">Classrooms</option>
            <option value="subscription">Subscriptions</option>
          </select>
          <select id="filterStatus" class="filter-select">
            <option value="">All Status</option>
            <option value="completed">Completed</option>
            <option value="pending">Pending</option>
            <option value="refunded">Refunded</option>
          </select>
          <input
            type="month"
            id="filterDate"
            class="filter-select"
            value="2024-01"
          />
        </div>

        <!-- Transactions Table -->
        <div class="dashboard-card fade-in">
          <div class="card-header">
            <div class="card-icon">ðŸ“‹</div>
            <h3 class="card-title">Purchase History</h3>
          </div>

          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Transaction ID</th>
                  <th>Date</th>
                  <th>Description</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="transactionsTable">
                <!-- Transactions will be loaded here -->
              </tbody>
            </table>
          </div>

          <div class="table-pagination" id="pagination">
            <!-- Pagination will be added here -->
          </div>
        </div>

        <!-- Upcoming Renewals -->
        <div class="dashboard-card fade-in">
          <div class="card-header">
            <div class="card-icon">ðŸ”„</div>
            <h3 class="card-title">Upcoming Renewals</h3>
          </div>

          <div id="upcomingRenewals" class="renewals-list">
            <!-- Upcoming renewals will be loaded here -->
          </div>
        </div>
      </div>
    </main>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal-overlay" style="display: none">
      <div class="modal-content invoice-modal">
        <div class="modal-header">
          <h3>Invoice Details</h3>
          <button class="modal-close" onclick="closeInvoiceModal()">
            &times;
          </button>
        </div>
        <div class="modal-body" id="invoiceContent">
          <!-- Invoice content will be loaded here -->
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeInvoiceModal()">
            Close
          </button>
          <button class="btn btn-primary" onclick="downloadInvoice()">
            Download PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Global JavaScript -->
    <script src="../js/global.js"></script>
    <!-- Dashboard JavaScript -->
    <script src="../js/dashboard.js"></script>

    <script>
      let allTransactions = [];
      let filteredTransactions = [];
      let currentPage = 1;
      const itemsPerPage = 10;

      document.addEventListener("DOMContentLoaded", () => {
        loadTransactions();
        initializeFilters();
        loadUpcomingRenewals();
      });

      function loadTransactions() {
        // Extended transaction data
        allTransactions = [
          {
            id: "TXN-2024-001",
            date: "2024-01-15",
            description: "Business Japanese Mastery Course",
            type: "course",
            amount: 129.99,
            status: "completed",
            paymentMethod: "Credit Card (*4242)",
            invoice: "INV-001-2024.pdf",
          },
          {
            id: "TXN-2024-002",
            date: "2024-01-10",
            description: "Conversational Japanese Course",
            type: "course",
            amount: 79.99,
            status: "completed",
            paymentMethod: "Credit Card (*4242)",
            invoice: "INV-002-2024.pdf",
          },
          {
            id: "TXN-2024-003",
            date: "2024-01-08",
            description: "Morning Conversation Circle (Monthly)",
            type: "classroom",
            amount: 100.0,
            status: "completed",
            paymentMethod: "Credit Card (*4242)",
            invoice: "INV-003-2024.pdf",
          },
          {
            id: "TXN-2024-004",
            date: "2024-01-01",
            description: "Premium Subscription Renewal",
            type: "subscription",
            amount: 29.99,
            status: "completed",
            paymentMethod: "Credit Card (*4242)",
            invoice: "INV-004-2024.pdf",
          },
          {
            id: "TXN-2023-025",
            date: "2023-12-15",
            description: "Japanese for Beginners Course",
            type: "course",
            amount: 49.99,
            status: "completed",
            paymentMethod: "PayPal",
            invoice: "INV-025-2023.pdf",
          },
          {
            id: "TXN-2023-024",
            date: "2023-12-10",
            description: "Weekend Cultural Exchange",
            type: "classroom",
            amount: 30.0,
            status: "refunded",
            paymentMethod: "Credit Card (*4242)",
            invoice: "INV-024-2023.pdf",
          },
          {
            id: "TXN-2023-023",
            date: "2023-12-01",
            description: "Premium Subscription",
            type: "subscription",
            amount: 29.99,
            status: "completed",
            paymentMethod: "Credit Card (*4242)",
            invoice: "INV-023-2023.pdf",
          },
        ];

        filteredTransactions = [...allTransactions];
        displayTransactions();
        updatePagination();
      }

      function displayTransactions() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageTransactions = filteredTransactions.slice(
          startIndex,
          endIndex,
        );

        const tbody = document.getElementById("transactionsTable");
        tbody.innerHTML = pageTransactions
          .map(
            (transaction) => `
                <tr>
                    <td class="transaction-id">
                        <strong>${transaction.id}</strong>
                    </td>
                    <td>${formatDate(transaction.date)}</td>
                    <td class="transaction-description">
                        <div class="description-main">${transaction.description}</div>
                        <div class="description-meta">${transaction.paymentMethod}</div>
                    </td>
                    <td>
                        <span class="type-badge type-${transaction.type}">${capitalizeFirst(transaction.type)}</span>
                    </td>
                    <td class="transaction-amount">
                        <strong>$${transaction.amount.toFixed(2)}</strong>
                    </td>
                    <td>
                        <span class="status-badge status-${transaction.status}">
                            ${capitalizeFirst(transaction.status)}
                        </span>
                    </td>
                    <td class="transaction-actions">
                        <button class="btn-action btn-primary" onclick="viewInvoice('${transaction.id}')">
                            Invoice
                        </button>
                        <button class="btn-action btn-outline" onclick="downloadInvoiceDirectly('${transaction.invoice}')">
                            Download
                        </button>
                        ${
                          transaction.status === "completed"
                            ? `<button class="btn-action btn-secondary" onclick="requestRefund('${transaction.id}')">Refund</button>`
                            : ""
                        }
                    </td>
                </tr>
            `,
          )
          .join("");
      }

      function initializeFilters() {
        const searchInput = document.getElementById("searchTransactions");
        const typeFilter = document.getElementById("filterType");
        const statusFilter = document.getElementById("filterStatus");
        const dateFilter = document.getElementById("filterDate");

        [searchInput, typeFilter, statusFilter, dateFilter].forEach(
          (element) => {
            element.addEventListener("change", filterTransactions);
            element.addEventListener("input", filterTransactions);
          },
        );
      }

      function filterTransactions() {
        const searchTerm = document
          .getElementById("searchTransactions")
          .value.toLowerCase();
        const typeFilter = document.getElementById("filterType").value;
        const statusFilter = document.getElementById("filterStatus").value;
        const dateFilter = document.getElementById("filterDate").value;

        filteredTransactions = allTransactions.filter((transaction) => {
          const matchesSearch =
            transaction.description.toLowerCase().includes(searchTerm) ||
            transaction.id.toLowerCase().includes(searchTerm);

          const matchesType = !typeFilter || transaction.type === typeFilter;
          const matchesStatus =
            !statusFilter || transaction.status === statusFilter;

          let matchesDate = true;
          if (dateFilter) {
            const transactionMonth = transaction.date.substring(0, 7); // YYYY-MM
            matchesDate = transactionMonth === dateFilter;
          }

          return matchesSearch && matchesType && matchesStatus && matchesDate;
        });

        currentPage = 1;
        displayTransactions();
        updatePagination();
      }

      function updatePagination() {
        const totalPages = Math.ceil(
          filteredTransactions.length / itemsPerPage,
        );
        const pagination = document.getElementById("pagination");

        if (totalPages <= 1) {
          pagination.innerHTML = "";
          return;
        }

        let paginationHTML = '<div class="pagination-controls">';

        // Previous button
        if (currentPage > 1) {
          paginationHTML += `<button class="pagination-btn" onclick="changePage(${currentPage - 1})">Previous</button>`;
        }

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          if (i === currentPage) {
            paginationHTML += `<button class="pagination-btn active">${i}</button>`;
          } else if (
            i === 1 ||
            i === totalPages ||
            (i >= currentPage - 1 && i <= currentPage + 1)
          ) {
            paginationHTML += `<button class="pagination-btn" onclick="changePage(${i})">${i}</button>`;
          } else if (i === currentPage - 2 || i === currentPage + 2) {
            paginationHTML += '<span class="pagination-ellipsis">...</span>';
          }
        }

        // Next button
        if (currentPage < totalPages) {
          paginationHTML += `<button class="pagination-btn" onclick="changePage(${currentPage + 1})">Next</button>`;
        }

        paginationHTML += "</div>";
        pagination.innerHTML = paginationHTML;
      }

      function changePage(page) {
        currentPage = page;
        displayTransactions();
        updatePagination();
      }

      function loadUpcomingRenewals() {
        const renewals = [
          {
            service: "Premium Subscription",
            nextDate: "2024-02-01",
            amount: 29.99,
            frequency: "Monthly",
          },
          {
            service: "Morning Conversation Circle",
            nextDate: "2024-02-08",
            amount: 100.0,
            frequency: "Monthly",
          },
        ];

        const container = document.getElementById("upcomingRenewals");
        container.innerHTML = renewals
          .map(
            (renewal) => `
                <div class="renewal-item">
                    <div class="renewal-info">
                        <h4 class="renewal-service">${renewal.service}</h4>
                        <p class="renewal-frequency">${renewal.frequency} billing</p>
                        <p class="renewal-date">Next charge: ${formatDate(renewal.nextDate)}</p>
                    </div>
                    <div class="renewal-amount">
                        <span class="amount-value">$${renewal.amount.toFixed(2)}</span>
                        <button class="btn btn-outline btn-sm" onclick="manageSubscription('${renewal.service}')">
                            Manage
                        </button>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function viewInvoice(transactionId) {
        const transaction = allTransactions.find((t) => t.id === transactionId);
        if (!transaction) return;

        const invoiceContent = `
                <div class="invoice-header">
                    <div class="invoice-logo">
                        <span class="brand-icon">æ—¥</span>
                        <span>Nihongo Sekai</span>
                    </div>
                    <div class="invoice-info">
                        <h4>Invoice #${transaction.id}</h4>
                        <p>Date: ${formatDate(transaction.date)}</p>
                    </div>
                </div>
                
                <div class="invoice-details">
                    <div class="invoice-section">
                        <h5>Bill To:</h5>
                        <p>Demo User<br>demo@nihongosekai.com</p>
                    </div>
                    
                    <div class="invoice-section">
                        <h5>Payment Method:</h5>
                        <p>${transaction.paymentMethod}</p>
                    </div>
                </div>
                
                <div class="invoice-items">
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${transaction.description}</td>
                                <td>$${transaction.amount.toFixed(2)}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td><strong>Total</strong></td>
                                <td><strong>$${transaction.amount.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

        document.getElementById("invoiceContent").innerHTML = invoiceContent;
        document.getElementById("invoiceModal").style.display = "flex";
      }

      function closeInvoiceModal() {
        document.getElementById("invoiceModal").style.display = "none";
      }

      function downloadInvoice() {
        // In a real app, this would generate and download a PDF
        if (window.ToastManager) {
          window.ToastManager.show("Invoice download started!", "success");
        } else {
          alert("Invoice download started!");
        }
        closeInvoiceModal();
      }

      function downloadInvoiceDirectly(filename) {
        // In a real app, this would download the specified file
        if (window.ToastManager) {
          window.ToastManager.show(`Downloading ${filename}`, "success");
        } else {
          alert(`Downloading ${filename}`);
        }
      }

      function requestRefund(transactionId) {
        const confirmed = confirm(
          "Are you sure you want to request a refund for this transaction?",
        );
        if (confirmed) {
          if (window.ToastManager) {
            window.ToastManager.show(
              "Refund request submitted successfully!",
              "success",
            );
          } else {
            alert("Refund request submitted successfully!");
          }
        }
      }

      function manageSubscription(service) {
        window.location.href = `subscription-management.html?service=${encodeURIComponent(service)}`;
      }
    </script>

    <style>
      /* Transaction-specific styles */
      .transaction-id {
        font-family: "Courier New", monospace;
        color: var(--primary-color);
      }

      .transaction-description {
        min-width: 200px;
      }

      .description-main {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 2px;
      }

      .description-meta {
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .transaction-amount {
        font-family: "Courier New", monospace;
        color: var(--primary-color);
      }

      .transaction-actions {
        white-space: nowrap;
      }

      .type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .type-course {
        background: #e8f5e8;
        color: #2d7d32;
      }

      .type-classroom {
        background: #e3f2fd;
        color: #1976d2;
      }

      .type-subscription {
        background: #fff3e0;
        color: #f57c00;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-refunded {
        background: #f8d7da;
        color: #721c24;
      }

      .table-pagination {
        margin-top: 20px;
        display: flex;
        justify-content: center;
      }

      .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .pagination-btn {
        padding: 8px 12px;
        border: 1px solid #e9ecef;
        background: white;
        color: var(--text-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .pagination-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .pagination-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .pagination-ellipsis {
        padding: 8px 4px;
        color: var(--text-muted);
      }

      .renewals-list {
        margin-bottom: 20px;
      }

      .renewal-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
        margin-bottom: 12px;
      }

      .renewal-service {
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 4px 0;
        color: var(--text-color);
      }

      .renewal-frequency,
      .renewal-date {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin: 2px 0;
      }

      .renewal-amount {
        text-align: right;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-end;
      }

      .amount-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-color);
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
      }

      /* Modal styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }

      .invoice-modal {
        background: white;
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
      }

      .modal-body {
        padding: 20px;
      }

      .modal-footer {
        padding: 20px;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .invoice-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--primary-color);
      }

      .invoice-logo {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
      }

      .invoice-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
      }

      .invoice-section h5 {
        margin: 0 0 8px 0;
        color: var(--text-color);
        font-weight: 600;
      }

      .invoice-section p {
        margin: 0;
        color: var(--text-muted);
        line-height: 1.4;
      }

      .invoice-table {
        width: 100%;
        border-collapse: collapse;
      }

      .invoice-table th,
      .invoice-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }

      .invoice-table th {
        background: #f8f9fa;
        font-weight: 600;
      }

      .total-row {
        background: #f8f9fa;
        font-weight: 600;
      }

      @media (max-width: 768px) {
        .transaction-actions {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .renewal-item {
          flex-direction: column;
          gap: 12px;
          text-align: center;
        }

        .renewal-amount {
          align-items: center;
        }

        .invoice-details {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .invoice-header {
          flex-direction: column;
          gap: 12px;
          text-align: center;
        }

        .data-table {
          font-size: 0.8rem;
        }

        .data-table th,
        .data-table td {
          padding: 8px 4px;
        }
      }
    </style>
  </body>
</html>
